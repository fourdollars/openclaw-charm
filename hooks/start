#!/bin/bash
set -e

# OpenClaw Juju Charm - Start Hook
# This hook starts the OpenClaw Gateway service

CHARM_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
source "$CHARM_DIR/hooks/common.sh"

log_info "Starting OpenClaw"

status-set maintenance "Starting OpenClaw service"

# Validate configuration (non-blocking - will set status to blocked if issues found)
if ! validate_config; then
    log_warn "Configuration validation failed - service will start but may not be functional"
fi

# Generate/update configuration
generate_config

# Open required ports
open_ports

# Start the service
if start_openclaw; then
    port="$(config-get gateway-port)"
    bind="$(config-get gateway-bind)"
    
    # Determine the IP address to show in status
    if [ "$bind" = "loopback" ]; then
        ip="127.0.0.1"
    else
        ip=$(unit-get private-address)
    fi
    
    url="http://${ip}:${port}"
    
    # Check if configuration is valid and set appropriate status
    if validate_config; then
        status-set active "Gateway: $url"
        log_info "OpenClaw started successfully with valid configuration"
    else
        status-set blocked "OpenClaw running but configuration incomplete (missing API keys or tokens)"
        log_warn "OpenClaw service started but requires valid configuration"
    fi
else
    status-set blocked "Failed to start OpenClaw - check logs"
    exit 1
fi
