#!/bin/bash

CHARM_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
source "$CHARM_DIR/hooks/common.sh"

ROLE="$(get_unit_role)"
log_info "Starting OpenClaw as $ROLE"

status-set maintenance "Starting OpenClaw $ROLE service"

if [ "$ROLE" = "gateway" ]; then
    if ! validate_config; then
        log_warn "Configuration validation failed - service will start but may not be functional"
    fi
    
    if ! validate_gateway_bind; then
        status-set blocked "Multi-unit deployment requires gateway-bind=lan (currently: $(config-get gateway-bind))"
        log_error "Cannot start Gateway with gateway-bind=loopback in multi-unit deployment"
        exit 1
    fi
    
    generate_config
    open_ports
    
    if is_gateway_running; then
        log_info "Gateway service already running (likely from upgrade-charm hook)"
        port="$(config-get gateway-port)"
        bind="$(config-get gateway-bind)"
        
        if [ "$bind" = "loopback" ]; then
            ip="127.0.0.1"
        else
            ip=$(unit-get private-address)
        fi
        
        url="http://${ip}:${port}"
        
        gateway_token=$(jq -r '.gateway.auth.token // empty' /home/ubuntu/.openclaw/openclaw.json 2>/dev/null)
        
        gateway_host=$(unit-get private-address)
        
        relation_id=$(relation-ids openclaw-cluster 2>/dev/null | head -1)
        if [ -n "$relation_id" ]; then
            relation-set -r "$relation_id" gateway-host="$gateway_host" || true
            relation-set -r "$relation_id" gateway-port="$port" || true
            if [ -n "$gateway_token" ]; then
                relation-set -r "$relation_id" gateway-token="$gateway_token" || true
            fi
        fi
        
        if validate_config; then
            status-set active "Gateway: $url"
            log_info "Gateway already running and healthy"
        else
            status-set blocked "Gateway running but configuration incomplete"
            log_warn "Gateway requires valid configuration"
        fi
        exit 0
    elif start_openclaw; then
        port="$(config-get gateway-port)"
        bind="$(config-get gateway-bind)"
        
        if [ "$bind" = "loopback" ]; then
            ip="127.0.0.1"
        else
            ip=$(unit-get private-address)
        fi
        
        url="http://${ip}:${port}"
        
        gateway_token=$(jq -r '.gateway.auth.token // empty' /home/ubuntu/.openclaw/openclaw.json 2>/dev/null)
        
        # For Node connections, always use private-address even if bind is loopback
        gateway_host=$(unit-get private-address)
        
        # Set relation data with relation ID
        relation_id=$(relation-ids openclaw-cluster 2>/dev/null | head -1)
        if [ -n "$relation_id" ]; then
            relation-set -r "$relation_id" gateway-host="$gateway_host" || true
            relation-set -r "$relation_id" gateway-port="$port" || true
            if [ -n "$gateway_token" ]; then
                relation-set -r "$relation_id" gateway-token="$gateway_token" || true
            fi
        fi
        
        # Bootstrap operator device for fresh deployments
        # This solves the chicken-and-egg problem where gateway needs an operator to function
        log_info "Checking for operator device bootstrap..."
        if [ -x "/usr/local/bin/openclaw-bootstrap-operator" ]; then
            # Wait for gateway to be fully started (increased from 3s to 10s)
            log_info "Waiting 10 seconds for gateway to fully start..."
            sleep 10
            
            # Trigger operator device creation by attempting a CLI command
            # This will create the operator device request in pending.json
            log_info "Triggering operator device request via CLI..."
            sudo -u ubuntu bash -l -c ". ~/.nvm/nvm.sh && nvm use ${NODE_VERSION:-24} >/dev/null 2>&1 && openclaw devices list >/dev/null 2>&1" || true
            
            # Give a moment for the device request to be written to pending.json
            sleep 2
            
            # Run bootstrap script (will wait up to 60s for operator device)
            log_info "Running bootstrap script..."
            if sudo -u ubuntu /usr/local/bin/openclaw-bootstrap-operator; then
                log_info "Operator device bootstrapped successfully - restarting gateway"
                # Restart gateway to load the paired operator device
                stop_openclaw
                sleep 2
                start_openclaw
            else
                log_warn "Operator bootstrap failed or not needed - gateway may require manual device approval"
            fi
        fi
        
        if validate_config; then
            status-set active "Gateway: $url"
            log_info "OpenClaw Gateway started successfully with valid configuration"
        else
            status-set blocked "Gateway running but configuration incomplete"
            log_warn "OpenClaw Gateway started but requires valid configuration"
        fi
        exit 0
    else
        status-set blocked "Failed to start Gateway - check logs"
        exit 1
    fi
else
    if ! generate_node_config; then
        status-set blocked "Waiting for Gateway connection info from leader"
        log_info "Node cannot start yet - waiting for Gateway info"
        exit 0
    fi
    
    if ! create_node_systemd_service; then
        status-set blocked "Failed to create Node service"
        exit 1
    fi
    
    if is_node_running; then
        log_info "Node service already running (likely from upgrade-charm hook)"
        gateway_unit=""
        gateway_host=""
        gateway_port=""
        gateway_token=""
        read -r gateway_unit gateway_host gateway_port gateway_token <<< "$(get_gateway_info)"
        
        if [ -n "$gateway_unit" ] && [ -n "$gateway_host" ] && [ -n "$gateway_port" ]; then
            status-set active "Node - connected to ${gateway_unit}"
            log_info "Node already running and connected to Gateway ${gateway_unit}"
        else
            status-set active "Node service started"
            log_info "Node already running"
        fi
        exit 0
    elif start_openclaw_node; then
        gateway_unit=""
        gateway_host=""
        gateway_port=""
        gateway_token=""
        read -r gateway_unit gateway_host gateway_port gateway_token <<< "$(get_gateway_info)"
        
        if [ -n "$gateway_unit" ] && [ -n "$gateway_host" ] && [ -n "$gateway_port" ]; then
            status-set active "Node - connected to ${gateway_unit}"
            log_info "OpenClaw Node started and connected to Gateway ${gateway_unit}"
        else
            status-set active "Node service started"
            log_info "OpenClaw Node started"
        fi
        exit 0
    else
        status-set blocked "Failed to start Node - check logs"
        exit 1
    fi
fi
