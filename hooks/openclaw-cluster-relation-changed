#!/bin/bash
set -e

CHARM_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
source "$CHARM_DIR/hooks/common.sh"

ROLE="$(get_unit_role)"
log_info "Peer relation changed - role: $ROLE"

if [ "$ROLE" = "gateway" ]; then
    # Gateway: Auto-approve pending node devices from peer relation
    log_info "Gateway: Waiting for nodes to connect before auto-approval"
    
    # Wait for nodes to establish connection and create device pairing requests
    # Node service starts and connects within ~10 seconds (see node startup in this hook)
    sleep 15
    
    log_info "Gateway: Running auto-approval for pending node devices"
    
    if [ -x /usr/local/bin/openclaw-auto-approve ]; then
        if sudo -u ubuntu /usr/local/bin/openclaw-auto-approve 2>&1 | while IFS= read -r line; do log_info "Auto-approve: $line"; done; then
            log_info "Auto-approval completed successfully"
        else
            log_warn "Auto-approval script exited with error"
        fi
    else
        log_warn "Auto-approval script not found or not executable at /usr/local/bin/openclaw-auto-approve"
    fi
elif [ "$ROLE" = "node" ]; then
    gateway_unit=""
    gateway_host=""
    gateway_port=""
    read -r gateway_unit gateway_host gateway_port _ <<< "$(get_gateway_info)"
    
    if [ -n "$gateway_host" ] && [ -n "$gateway_port" ]; then
        log_info "Received Gateway info: ${gateway_host}:${gateway_port}"
        
        status-set maintenance "Updating node configuration"
        
        if generate_node_config; then
            create_node_systemd_service
            update_node_service_token
            
            if systemctl is-active --quiet openclaw-node.service; then
                restart_openclaw_node
            else
                start_openclaw_node
            fi
            
            sleep 10
            
            if is_node_paired; then
                if [ -n "$gateway_unit" ]; then
                    status-set active "Node - connected to ${gateway_unit}"
                else
                    status-set active "Node connected to ${gateway_host}:${gateway_port}"
                fi
            else
                status-set waiting "Waiting for device pairing approval"
            fi
        else
            status-set blocked "Failed to configure Node"
        fi
    else
        log_info "Gateway info not yet available"
        status-set waiting "Waiting for Gateway connection info"
    fi
fi
