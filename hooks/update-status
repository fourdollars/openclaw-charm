#!/bin/bash
set -e

# OpenClaw Juju Charm - Update Status Hook
# This hook updates the status message

CHARM_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
source "$CHARM_DIR/hooks/common.sh"

# Check if service is running
if systemctl is-active --quiet openclaw.service; then
    port="$(config-get gateway-port)"
    bind="$(config-get gateway-bind)"
    
    # Determine the IP address to show in status
    if [ "$bind" = "loopback" ]; then
        ip="127.0.0.1"
    else
        ip=$(unit-get private-address)
    fi
    
    url="http://${ip}:${port}"
    
    # Check if configuration is valid
    if validate_config; then
        status-set active "Gateway: $url"
    else
        status-set blocked "OpenClaw running but configuration incomplete"
    fi
else
    status-set blocked "OpenClaw service not running"
fi
