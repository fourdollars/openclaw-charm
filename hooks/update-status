#!/bin/bash
set -e

CHARM_DIR="$(cd "$(dirname "${BASH_SOURCE[0]})/.." && pwd)"
source "$CHARM_DIR/hooks/common.sh"

ROLE="$(get_unit_role)"
MANUAL_RAW="$(config-get manual)"
SHOULD_MANAGE="$(should_manage_config)"
log_debug "update-status: role=$ROLE, manual_raw='$MANUAL_RAW', should_manage='$SHOULD_MANAGE'"

if [ "$ROLE" = "gateway" ]; then
    # Check service state - accept both 'active' and 'activating' as valid
    service_state=$(run_systemctl_user show openclaw-gateway.service -p ActiveState --value 2>/dev/null || echo "failed")
    
    if [ "$service_state" = "active" ] || [ "$service_state" = "activating" ]; then
        port="$(config-get gateway-port)"
        bind="$(config-get gateway-bind)"
        
        if [ "$bind" = "loopback" ]; then
            ip="127.0.0.1"
        else
            ip=$(unit-get private-address)
        fi
        
        url="http://${ip}:${port}"
        
        # Auto-approve pending node devices
        if [ -x /usr/local/bin/openclaw-auto-approve ]; then
            if sudo -u ubuntu /usr/local/bin/openclaw-auto-approve 2>&1 | grep -q "Successfully approved:"; then
                log_info "Auto-approved pending node devices"
            fi
        fi
        
        # Check if manual mode is enabled
        manual_raw="$(config-get manual)"
        should_manage="$(should_manage_config)"
        if [ "$should_manage" = "false" ]; then
            status-set active "Gateway: $url (manual mode) [debug: manual_raw=$manual_raw]"
        elif validate_config; then
            status-set active "Gateway: $url [debug: manual_raw=$manual_raw, should_manage=$should_manage]"
        else
            status-set blocked "Gateway running but configuration incomplete"
        fi
    else
        status-set blocked "Gateway service not running"
    fi
else
    service_state=$(run_systemctl_user show openclaw-node.service -p ActiveState -p SubState --value 2>/dev/null | tr '\n' ',' || echo "failed,")
    
    if [[ "$service_state" == *"active"* ]] || [[ "$service_state" == *"auto-restart"* ]]; then
        read -r gateway_unit gateway_host gateway_port _ <<< "$(get_gateway_info)"
        
        # Check if manual mode is enabled
        manual_suffix=""
        if [ "$(should_manage_config)" = "false" ]; then
            manual_suffix=" (manual mode)"
        fi
        
        if [ -z "$gateway_host" ] || [ -z "$gateway_port" ]; then
            status-set blocked "Waiting for Gateway connection info"
        elif ! check_gateway_connection; then
            status-set blocked "Cannot reach Gateway at ${gateway_host}:${gateway_port}"
        elif is_node_paired; then
            if [ -n "$gateway_unit" ]; then
                status-set active "Node - connected to ${gateway_unit}${manual_suffix}"
            elif [ -n "$gateway_host" ] && [ -n "$gateway_port" ]; then
                status-set active "Node connected to ${gateway_host}:${gateway_port}${manual_suffix}"
            else
                status-set blocked "Waiting for Gateway connection info"
            fi
        else
            status-set waiting "Waiting for device pairing approval"
        fi
    else
        status-set blocked "Node service not running"
    fi
fi
