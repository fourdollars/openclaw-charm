#!/bin/bash
set -e

# OpenClaw Juju Charm - Upgrade Charm Hook
# This hook handles charm upgrades

CHARM_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
source "$CHARM_DIR/hooks/common.sh"

log_info "Upgrading charm"

status-set maintenance "Upgrading charm"

# Recreate systemd service in case it changed
create_systemd_service

# If auto-update is enabled, update OpenClaw
if [ "$(config-get auto-update)" = "True" ]; then
    log_info "Auto-update enabled - updating OpenClaw"
    INSTALL_METHOD="$(config-get install-method)"
    OPENCLAW_VERSION="$(config-get version)"
    
    status-set maintenance "Updating OpenClaw"
    
    case "$INSTALL_METHOD" in
        npm)
            su - ubuntu -c "npm update -g openclaw@${OPENCLAW_VERSION}"
            ;;
        pnpm)
            su - ubuntu -c "pnpm update -g openclaw@${OPENCLAW_VERSION}"
            ;;
        source)
            su - ubuntu -c "cd /home/ubuntu/openclaw && git fetch && git checkout ${OPENCLAW_VERSION} && pnpm install && pnpm build"
            ;;
    esac
    
    INSTALLED_VERSION=$(timeout 5 su - ubuntu -c "openclaw --version" 2>/dev/null || echo "unknown")
    log_info "OpenClaw updated to version $INSTALLED_VERSION"
fi

# Regenerate configuration
generate_config

# Restart service if running
if systemctl is-active --quiet openclaw.service; then
    log_info "Restarting OpenClaw after upgrade"
    if restart_openclaw; then
        port="$(config-get gateway-port)"
        ip=$(unit-get private-address)
        url="http://${ip}:${port}"
        
        # Check if configuration is valid and set appropriate status
        if validate_config; then
            status-set active "Gateway: $url (upgraded)"
            log_info "Charm upgraded successfully with valid configuration"
        else
            status-set blocked "OpenClaw running but configuration incomplete (missing API keys)"
            log_warn "Charm upgraded but requires valid configuration"
        fi
    else
        status-set blocked "Failed to restart after upgrade"
        exit 1
    fi
else
    status-set active "Charm upgraded (service not running)"
fi
