#!/bin/bash
set -e

CHARM_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
source "$CHARM_DIR/hooks/common.sh"

log_info "Upgrading charm"

status-set maintenance "Upgrading charm"

INSTALL_METHOD="$(config-get install-method)"

if [ ! -d "/home/ubuntu/.nvm" ] && [ "$INSTALL_METHOD" != "bun" ]; then
    log_info "nvm not found - installing for migration to user services"
    install_nodejs
fi

if [ ! -d "/home/ubuntu/.bun" ] && [ "$INSTALL_METHOD" = "bun" ]; then
    log_info "Bun not found - installing for migration to user services"
    install_bun
fi

if ! su - ubuntu -c "command -v openclaw" >/dev/null 2>&1; then
    log_info "OpenClaw not found in user path - reinstalling"
    OPENCLAW_VERSION="$(config-get version)"
    
    case "$INSTALL_METHOD" in
        npm|pnpm)
            su - ubuntu -c "
                export NVM_DIR=\"/home/ubuntu/.nvm\"
                [ -s \"\$NVM_DIR/nvm.sh\" ] && . \"\$NVM_DIR/nvm.sh\"
                npm install -g openclaw@${OPENCLAW_VERSION}
            "
            ;;
        bun)
            su - ubuntu -c "bun install -g openclaw@${OPENCLAW_VERSION}"
            ;;
        source)
            if [ ! -d "/home/ubuntu/openclaw" ]; then
                su - ubuntu -c "cd /home/ubuntu && git clone https://github.com/openclaw/openclaw.git"
            fi
            su - ubuntu -c "
                export NVM_DIR=\"/home/ubuntu/.nvm\"
                [ -s \"\$NVM_DIR/nvm.sh\" ] && . \"\$NVM_DIR/nvm.sh\"
                cd /home/ubuntu/openclaw && git fetch && git checkout ${OPENCLAW_VERSION} && pnpm install && pnpm build
            "
            ;;
    esac
fi

ROLE="$(get_unit_role)"

if [ "$ROLE" = "gateway" ]; then
    create_systemd_service
else
    create_node_systemd_service
fi

if [ "$(config-get auto-update)" = "True" ]; then
    log_info "Auto-update enabled - updating OpenClaw"
    OPENCLAW_VERSION="$(config-get version)"
    
    status-set maintenance "Updating OpenClaw"
    
    case "$INSTALL_METHOD" in
        npm|pnpm)
            su - ubuntu -c "
                export NVM_DIR=\"/home/ubuntu/.nvm\"
                [ -s \"\$NVM_DIR/nvm.sh\" ] && . \"\$NVM_DIR/nvm.sh\"
                npm update -g openclaw@${OPENCLAW_VERSION}
            "
            ;;
        bun)
            su - ubuntu -c "bun update -g openclaw@${OPENCLAW_VERSION}"
            ;;
        source)
            su - ubuntu -c "
                export NVM_DIR=\"/home/ubuntu/.nvm\"
                [ -s \"\$NVM_DIR/nvm.sh\" ] && . \"\$NVM_DIR/nvm.sh\"
                cd /home/ubuntu/openclaw && git fetch && git checkout ${OPENCLAW_VERSION} && pnpm install && pnpm build
            "
            ;;
    esac
    
    INSTALLED_VERSION=$(su - ubuntu -c "timeout 5 openclaw --version" 2>/dev/null || echo "unknown")
    log_info "OpenClaw updated to version $INSTALLED_VERSION"
fi

generate_config

if [ "$ROLE" = "gateway" ]; then
    if su - ubuntu -c "systemctl --user is-active --quiet openclaw-gateway.service" 2>/dev/null; then
        log_info "Restarting OpenClaw Gateway after upgrade"
        if restart_openclaw; then
            port="$(config-get gateway-port)"
            ip=$(unit-get private-address)
            url="http://${ip}:${port}"
            
            if validate_config; then
                status-set active "Gateway: $url (upgraded)"
                log_info "Charm upgraded successfully with valid configuration"
            else
                status-set blocked "OpenClaw running but configuration incomplete (missing API keys)"
                log_warn "Charm upgraded but requires valid configuration"
            fi
        else
            status-set blocked "Failed to restart after upgrade"
            exit 1
        fi
    else
        log_info "Starting Gateway service after upgrade"
        if start_openclaw; then
            port="$(config-get gateway-port)"
            ip=$(unit-get private-address)
            url="http://${ip}:${port}"
            
            if validate_config; then
                status-set active "Gateway: $url (upgraded)"
            else
                status-set blocked "Gateway started but configuration incomplete"
            fi
        else
            status-set blocked "Failed to start Gateway after upgrade"
            exit 1
        fi
    fi
else
    if su - ubuntu -c "systemctl --user is-active --quiet openclaw-node.service" 2>/dev/null; then
        log_info "Restarting OpenClaw Node after upgrade"
        if restart_openclaw_node; then
            status-set active "Node - connected to gateway (upgraded)"
        else
            status-set blocked "Failed to restart Node after upgrade"
            exit 1
        fi
    else
        log_info "Starting Node service after upgrade"
        if start_openclaw_node; then
            status-set active "Node - connected to gateway (upgraded)"
        else
            status-set blocked "Failed to start Node after upgrade"
            exit 1
        fi
    fi
fi

