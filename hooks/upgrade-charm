#!/bin/bash
set -e

CHARM_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
source "$CHARM_DIR/hooks/common.sh"

log_info "Upgrading charm"

status-set maintenance "Upgrading charm"

INSTALL_METHOD="$(config-get install-method)"

if [ ! -d "/home/ubuntu/.nvm" ] && [ "$INSTALL_METHOD" != "bun" ]; then
    log_info "nvm not found - installing for migration to user services"
    install_nodejs
fi

if [ ! -d "/home/ubuntu/.bun" ] && [ "$INSTALL_METHOD" = "bun" ]; then
    log_info "Bun not found - installing for migration to user services"
    install_bun
fi

if ! sudo -u ubuntu bash -l -c "command -v openclaw" >/dev/null 2>&1; then
    log_info "OpenClaw not found in user path - reinstalling"
    OPENCLAW_VERSION="$(config-get version)"
    
    case "$INSTALL_METHOD" in
        npm|pnpm)
            sudo -u ubuntu bash -l -c "
                export NVM_DIR=\"/home/ubuntu/.nvm\"
                [ -s \"\$NVM_DIR/nvm.sh\" ] && . \"\$NVM_DIR/nvm.sh\"
                npm install -g openclaw@${OPENCLAW_VERSION}
            "
            
            # Make openclaw accessible system-wide for npm/pnpm
            if [ -d "/home/ubuntu/.nvm" ]; then
                # shellcheck disable=SC2012
                nvm_node_version="$(ls -1 /home/ubuntu/.nvm/versions/node | sort -V | tail -1)"
                if [ -f "/home/ubuntu/.nvm/versions/node/${nvm_node_version}/bin/openclaw" ]; then
                    ln -sf "/home/ubuntu/.nvm/versions/node/${nvm_node_version}/bin/openclaw" /usr/local/bin/openclaw
                    log_info "Created symlink for openclaw at /usr/local/bin/openclaw"
                fi
            fi
            ;;
        bun)
            sudo -u ubuntu bash -l -c "bun install -g openclaw@${OPENCLAW_VERSION}"
            
            # Make openclaw accessible system-wide for bun
            if [ -f "/home/ubuntu/.bun/bin/openclaw" ]; then
                ln -sf "/home/ubuntu/.bun/bin/openclaw" /usr/local/bin/openclaw
                log_info "Created symlink for openclaw at /usr/local/bin/openclaw"
            fi
            ;;
        source)
            if [ ! -d "/home/ubuntu/openclaw" ]; then
                sudo -u ubuntu bash -l -c "cd /home/ubuntu && git clone https://github.com/openclaw/openclaw.git"
            fi
            sudo -u ubuntu bash -l -c "
                export NVM_DIR=\"/home/ubuntu/.nvm\"
                [ -s \"\$NVM_DIR/nvm.sh\" ] && . \"\$NVM_DIR/nvm.sh\"
                cd /home/ubuntu/openclaw && git fetch && git checkout ${OPENCLAW_VERSION} && pnpm install && pnpm build
            "
            
            # Make openclaw accessible system-wide for source install
            if [ -d "/home/ubuntu/.nvm" ]; then
                # shellcheck disable=SC2012
                nvm_node_version="$(ls -1 /home/ubuntu/.nvm/versions/node | sort -V | tail -1)"
                if [ -f "/home/ubuntu/.nvm/versions/node/${nvm_node_version}/bin/openclaw" ]; then
                    ln -sf "/home/ubuntu/.nvm/versions/node/${nvm_node_version}/bin/openclaw" /usr/local/bin/openclaw
                    log_info "Created symlink for openclaw at /usr/local/bin/openclaw"
                fi
            fi
            ;;
    esac
fi

# Deploy helper scripts
log_info "Deploying helper scripts"
if [ -f "$CHARM_DIR/files/openclaw-auto-approve" ]; then
    cp "$CHARM_DIR/files/openclaw-auto-approve" /usr/local/bin/openclaw-auto-approve
    chmod 755 /usr/local/bin/openclaw-auto-approve
    chown ubuntu:ubuntu /usr/local/bin/openclaw-auto-approve
    log_info "Auto-approve helper script deployed"
else
    log_warn "openclaw-auto-approve script not found in charm files"
fi

if [ -f "$CHARM_DIR/files/openclaw-bootstrap-operator" ]; then
    cp "$CHARM_DIR/files/openclaw-bootstrap-operator" /usr/local/bin/openclaw-bootstrap-operator
    chmod 755 /usr/local/bin/openclaw-bootstrap-operator
    chown ubuntu:ubuntu /usr/local/bin/openclaw-bootstrap-operator
    log_info "Bootstrap-operator helper script deployed"
else
    log_warn "openclaw-bootstrap-operator script not found in charm files"
fi

ROLE="$(get_unit_role)"

if [ "$ROLE" = "gateway" ]; then
    create_systemd_service
else
    create_node_systemd_service
fi

if [ "$(config-get auto-update)" = "True" ]; then
    log_info "Auto-update enabled - updating OpenClaw"
    OPENCLAW_VERSION="$(config-get version)"
    
    status-set maintenance "Updating OpenClaw"
    
    case "$INSTALL_METHOD" in
        npm|pnpm)
            sudo -u ubuntu bash -l -c "
                export NVM_DIR=\"/home/ubuntu/.nvm\"
                [ -s \"\$NVM_DIR/nvm.sh\" ] && . \"\$NVM_DIR/nvm.sh\"
                npm update -g openclaw@${OPENCLAW_VERSION}
            "
            ;;
        bun)
            sudo -u ubuntu bash -l -c "bun update -g openclaw@${OPENCLAW_VERSION}"
            ;;
        source)
            sudo -u ubuntu bash -l -c "
                export NVM_DIR=\"/home/ubuntu/.nvm\"
                [ -s \"\$NVM_DIR/nvm.sh\" ] && . \"\$NVM_DIR/nvm.sh\"
                cd /home/ubuntu/openclaw && git fetch && git checkout ${OPENCLAW_VERSION} && pnpm install && pnpm build
            "
            ;;
    esac
    
    INSTALLED_VERSION=$(sudo -u ubuntu bash -l -c "timeout 5 openclaw --version" 2>/dev/null || echo "unknown")
    log_info "OpenClaw updated to version $INSTALLED_VERSION"
fi

if [ "$ROLE" = "gateway" ]; then
    generate_config
    if is_gateway_running; then
        log_info "Gateway service already running - restarting after upgrade"
        if restart_openclaw; then
            port="$(config-get gateway-port)"
            ip=$(unit-get private-address)
            url="http://${ip}:${port}"
            
            if validate_config; then
                status-set active "Gateway: $url (upgraded)"
                log_info "Charm upgraded successfully with valid configuration"
            else
                status-set blocked "OpenClaw running but configuration incomplete (missing API keys)"
                log_warn "Charm upgraded but requires valid configuration"
            fi
        else
            status-set blocked "Failed to restart after upgrade"
            exit 1
        fi
    else
        log_info "Gateway service not running - deferring start to start hook"
        status-set maintenance "Upgrade complete, waiting for start hook"
    fi
else
    # Node unit - remove openclaw.json if it exists (should only have node.json)
    if [ -f "/home/ubuntu/.openclaw/openclaw.json" ]; then
        log_info "Removing openclaw.json from Node unit (Nodes should only have node.json)"
        rm -f /home/ubuntu/.openclaw/openclaw.json
    fi
    
    if is_node_running; then
        log_info "Node service already running - restarting after upgrade"
        if restart_openclaw_node; then
            status-set active "Node - connected to gateway (upgraded)"
        else
            status-set blocked "Failed to restart Node after upgrade"
            exit 1
        fi
    else
        log_info "Node service not running - deferring start to start hook"
        status-set maintenance "Upgrade complete, waiting for start hook"
    fi
fi

