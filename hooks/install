#!/bin/bash
set -e

# OpenClaw Juju Charm - Install Hook
# This hook installs all dependencies and prepares the system for OpenClaw

CHARM_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
source "$CHARM_DIR/hooks/common.sh"

log_info "Starting OpenClaw installation"

# Set status
status-set maintenance "Installing system dependencies"

# Install build dependencies FIRST (required by runtime installers)
log_info "Installing system dependencies"
apt-get update
apt-get install -y \
    curl \
    wget \
    git \
    build-essential \
    python3 \
    sqlite3 \
    libsqlite3-dev \
    ca-certificates \
    gnupg \
    unzip

# Install Google Chrome for browser automation if enabled
if [ "$(config-get enable-browser-tool)" = "True" ]; then
    log_info "Installing Google Chrome for browser automation"
    wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | apt-key add -
    echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" > /etc/apt/sources.list.d/google-chrome.list
    apt-get update
    apt-get install -y google-chrome-stable
fi

# Use ubuntu user (already exists on Ubuntu systems)

# Install runtime based on install method
INSTALL_METHOD="$(config-get install-method)"

case "$INSTALL_METHOD" in
    npm|pnpm|source)
        install_nodejs
        ;;
    bun)
        install_bun
        ;;
    *)
        log_error "Unknown install method: $INSTALL_METHOD"
        exit 1
        ;;
esac

# Create required directories
log_info "Creating OpenClaw directories"
mkdir -p /home/ubuntu/.openclaw/{credentials,workspace}
chown -R ubuntu:ubuntu /home/ubuntu/.openclaw

# Install OpenClaw based on configured method
OPENCLAW_VERSION="$(config-get version)"

status-set maintenance "Installing OpenClaw ($INSTALL_METHOD)"

case "$INSTALL_METHOD" in
    npm|pnpm)
        log_info "Installing OpenClaw via npm (v${OPENCLAW_VERSION})"
        # Install globally to system path (npm works reliably as root)
        npm install -g "openclaw@${OPENCLAW_VERSION}"
        ;;
    bun)
        log_info "Installing OpenClaw via Bun (v${OPENCLAW_VERSION})"
        
        # Install as ubuntu user to their home directory
        su - ubuntu -c "bun install -g openclaw@${OPENCLAW_VERSION}"
        
        # OpenClaw's entry point uses #!/usr/bin/env node shebang
        # Create a wrapper script that uses Bun instead
        if [ -f /home/ubuntu/.bun/install/global/node_modules/openclaw/openclaw.mjs ]; then
            cat > /usr/local/bin/openclaw <<'EOF'
#!/bin/bash
exec /usr/local/bin/bun /home/ubuntu/.bun/install/global/node_modules/openclaw/openclaw.mjs "$@"
EOF
            chmod +x /usr/local/bin/openclaw
        else
            log_error "Bun installed packages but openclaw.mjs not found"
            exit 1
        fi
        ;;
    source)
        log_info "Installing OpenClaw from source"
        su - ubuntu -c "cd /home/ubuntu && git clone https://github.com/openclaw/openclaw.git"
        if [ "$OPENCLAW_VERSION" != "latest" ]; then
            su - ubuntu -c "cd /home/ubuntu/openclaw && git checkout ${OPENCLAW_VERSION}"
        fi
        su - ubuntu -c "cd /home/ubuntu/openclaw && npm install -g pnpm && pnpm install && pnpm build"
        # Create symlink to openclaw command
        ln -sf /home/ubuntu/openclaw/packages/cli/dist/index.js /usr/local/bin/openclaw
        chmod +x /usr/local/bin/openclaw
        ;;
    *)
        log_error "Unknown install method: $INSTALL_METHOD"
        exit 1
        ;;
esac

# Verify installation
if ! command -v openclaw >/dev/null 2>&1; then
    log_error "OpenClaw installation failed - command not found"
    status-set blocked "Installation failed - openclaw command not found"
    exit 1
fi

INSTALLED_VERSION=$(timeout 5 openclaw --version 2>/dev/null || echo "unknown")
log_info "OpenClaw installed successfully: version $INSTALLED_VERSION"

# Create systemd service
create_systemd_service

status-set active "Installation complete"
log_info "OpenClaw installation completed successfully"
