#!/bin/bash
set -e

# OpenClaw Juju Charm - Install Hook
# This hook installs all dependencies and prepares the system for OpenClaw

CHARM_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
source "$CHARM_DIR/hooks/common.sh"

log_info "Starting OpenClaw installation"

# Set status
status-set maintenance "Installing system dependencies"

# Install build dependencies FIRST (required by runtime installers)
log_info "Installing system dependencies"
apt-get update
apt-get install -y \
    curl \
    wget \
    git \
    build-essential \
    python3 \
    sqlite3 \
    libsqlite3-dev \
    ca-certificates \
    gnupg \
    unzip

ensure_chrome_installed

# Use ubuntu user (already exists on Ubuntu systems)

# Install runtime based on install method
INSTALL_METHOD="$(config-get install-method)"

case "$INSTALL_METHOD" in
    npm|pnpm|source)
        install_nodejs
        ;;
    bun)
        install_bun
        ;;
    *)
        log_error "Unknown install method: $INSTALL_METHOD"
        exit 1
        ;;
esac

# Create required directories
log_info "Creating OpenClaw directories"
mkdir -p /home/ubuntu/.openclaw/{credentials,workspace}
chown -R ubuntu:ubuntu /home/ubuntu/.openclaw

# Install OpenClaw based on configured method
OPENCLAW_VERSION="$(config-get version)"

status-set maintenance "Installing OpenClaw ($INSTALL_METHOD)"

case "$INSTALL_METHOD" in
    npm|pnpm)
        log_info "Installing OpenClaw via npm (v${OPENCLAW_VERSION})"
        sudo -u ubuntu bash -l -c "
            export NVM_DIR=\"/home/ubuntu/.nvm\"
            [ -s \"\$NVM_DIR/nvm.sh\" ] && . \"\$NVM_DIR/nvm.sh\"
            npm install -g openclaw@${OPENCLAW_VERSION}
        "
        
        # Make openclaw accessible system-wide for npm/pnpm
        if [ -d "/home/ubuntu/.nvm" ]; then
            # shellcheck disable=SC2012
            nvm_node_version="$(ls -1 /home/ubuntu/.nvm/versions/node | sort -V | tail -1)"
            if [ -f "/home/ubuntu/.nvm/versions/node/${nvm_node_version}/bin/openclaw" ]; then
                ln -sf "/home/ubuntu/.nvm/versions/node/${nvm_node_version}/bin/openclaw" /usr/local/bin/openclaw
                log_info "Created symlink for openclaw at /usr/local/bin/openclaw"
            fi
        fi
        ;;
    bun)
        log_info "Installing OpenClaw via Bun (v${OPENCLAW_VERSION})"
        sudo -u ubuntu bash -l -c "bun install -g openclaw@${OPENCLAW_VERSION}"
        
        # Make openclaw accessible system-wide for bun
        if [ -f "/home/ubuntu/.bun/bin/openclaw" ]; then
            ln -sf "/home/ubuntu/.bun/bin/openclaw" /usr/local/bin/openclaw
            log_info "Created symlink for openclaw at /usr/local/bin/openclaw"
        fi
        ;;
    source)
        log_info "Installing OpenClaw from source"
        sudo -u ubuntu bash -l -c "cd /home/ubuntu && git clone https://github.com/openclaw/openclaw.git"
        if [ "$OPENCLAW_VERSION" != "latest" ]; then
            sudo -u ubuntu bash -l -c "cd /home/ubuntu/openclaw && git checkout ${OPENCLAW_VERSION}"
        fi
        sudo -u ubuntu bash -l -c "
            export NVM_DIR=\"/home/ubuntu/.nvm\"
            [ -s \"\$NVM_DIR/nvm.sh\" ] && . \"\$NVM_DIR/nvm.sh\"
            npm install -g pnpm && cd /home/ubuntu/openclaw && pnpm install && pnpm build
        "
        
        # Make openclaw accessible system-wide for source install
        if [ -d "/home/ubuntu/.nvm" ]; then
            # shellcheck disable=SC2012
            nvm_node_version="$(ls -1 /home/ubuntu/.nvm/versions/node | sort -V | tail -1)"
            if [ -f "/home/ubuntu/.nvm/versions/node/${nvm_node_version}/bin/openclaw" ]; then
                ln -sf "/home/ubuntu/.nvm/versions/node/${nvm_node_version}/bin/openclaw" /usr/local/bin/openclaw
                log_info "Created symlink for openclaw at /usr/local/bin/openclaw"
            fi
        fi
        ;;
    *)
        log_error "Unknown install method: $INSTALL_METHOD"
        exit 1
        ;;
esac

# Verify installation (run as ubuntu user with proper environment)
if ! sudo -u ubuntu bash -l -c "
    export NVM_DIR=\"/home/ubuntu/.nvm\"
    [ -s \"\$NVM_DIR/nvm.sh\" ] && . \"\$NVM_DIR/nvm.sh\"
    export BUN_INSTALL=\"/home/ubuntu/.bun\"
    [ -d \"\$BUN_INSTALL/bin\" ] && export PATH=\"\$BUN_INSTALL/bin:\$PATH\"
    command -v openclaw
" >/dev/null 2>&1; then
    log_error "OpenClaw installation failed - command not found for ubuntu user"
    status-set blocked "Installation failed - openclaw command not found"
    exit 1
fi

INSTALLED_VERSION=$(sudo -u ubuntu bash -l -c "
    export NVM_DIR=\"/home/ubuntu/.nvm\"
    [ -s \"\$NVM_DIR/nvm.sh\" ] && . \"\$NVM_DIR/nvm.sh\"
    export BUN_INSTALL=\"/home/ubuntu/.bun\"
    [ -d \"\$BUN_INSTALL/bin\" ] && export PATH=\"\$BUN_INSTALL/bin:\$PATH\"
    timeout 5 openclaw --version 2>/dev/null
" || echo "unknown")
log_info "OpenClaw installed successfully: version $INSTALLED_VERSION"

# Create systemd service
create_systemd_service

# Deploy helper scripts
log_info "Deploying helper scripts"
if [ -f "$CHARM_DIR/files/openclaw-auto-approve" ]; then
    cp "$CHARM_DIR/files/openclaw-auto-approve" /usr/local/bin/openclaw-auto-approve
    chmod 755 /usr/local/bin/openclaw-auto-approve
    chown ubuntu:ubuntu /usr/local/bin/openclaw-auto-approve
    log_info "Auto-approve helper script deployed"
else
    log_warn "openclaw-auto-approve script not found in charm files"
fi

if [ -f "$CHARM_DIR/files/openclaw-bootstrap-operator" ]; then
    cp "$CHARM_DIR/files/openclaw-bootstrap-operator" /usr/local/bin/openclaw-bootstrap-operator
    chmod 755 /usr/local/bin/openclaw-bootstrap-operator
    chown ubuntu:ubuntu /usr/local/bin/openclaw-bootstrap-operator
    log_info "Bootstrap-operator helper script deployed"
else
    log_warn "openclaw-bootstrap-operator script not found in charm files"
fi

# Note: OpenClaw initialization happens in config-changed/start hooks after role determination
# - Gateway units run: openclaw onboard (creates openclaw.json)
# - Node units run: openclaw node install (creates node.json and systemd service)
log_info "OpenClaw installation complete - configuration will be initialized by config-changed hook"

status-set active "Installation complete"
log_info "OpenClaw installation completed successfully"
