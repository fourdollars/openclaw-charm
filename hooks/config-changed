#!/bin/bash
set -e

CHARM_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
source "$CHARM_DIR/hooks/common.sh"

ROLE="$(get_unit_role)"
log_info "Configuration changed for $ROLE"

status-set maintenance "Updating $ROLE configuration"

if [ "$(should_manage_config)" = "false" ]; then
    log_info "Manual mode enabled - skipping configuration management"
    
    if [ "$ROLE" = "gateway" ]; then
        status-set active "Manual mode - user manages Gateway configuration"
    else
        if ! generate_node_config; then
            status-set blocked "Waiting for Gateway connection info from leader"
            exit 0
        fi
        
        if [ ! -f /home/ubuntu/.config/systemd/user/openclaw-node.service ]; then
            log_info "Creating Node service in manual mode"
            if ! create_node_systemd_service; then
                status-set blocked "Failed to create Node service"
                exit 1
            fi
        fi
        
        if run_systemctl_user is-active --quiet openclaw-node.service 2>/dev/null; then
            if restart_openclaw_node; then
                gateway_unit=""
                gateway_host=""
                gateway_port=""
                gateway_token=""
                read -r gateway_unit gateway_host gateway_port gateway_token <<< "$(get_gateway_info)"
                
                if [ -n "$gateway_unit" ]; then
                    status-set active "Manual mode - Node connected to ${gateway_unit}"
                else
                    status-set active "Manual mode - Node service restarted"
                fi
            fi
        else
            status-set active "Manual mode - user manages Node configuration"
        fi
    fi
    exit 0
fi

ensure_browser_installed

if [ "$ROLE" = "gateway" ]; then
    if ! validate_config; then
        status-set blocked "Configuration validation failed - check logs"
        exit 1
    fi
    
    if ! validate_gateway_bind; then
        status-set blocked "Multi-unit deployment requires gateway-bind=lan (currently: $(config-get gateway-bind))"
        log_error "Cannot run Gateway with gateway-bind=loopback in multi-unit deployment"
        exit 1
    fi
    
    INSTALL_METHOD="$(config-get install-method)"
    if [ "$INSTALL_METHOD" != "bun" ]; then
        CURRENT_NODE_VERSION=$(node --version 2>/dev/null | cut -d'.' -f1 | sed 's/v//' || echo "0")
        CONFIGURED_NODE_VERSION=$(config-get node-version)
        
        if [ "$CURRENT_NODE_VERSION" != "$CONFIGURED_NODE_VERSION" ]; then
            log_info "Node.js version changed - reinstalling"
            install_nodejs
        fi
    fi
    
    if [ "$(config-get auto-update)" = "True" ]; then
        log_info "Auto-update enabled - checking for updates"
        OPENCLAW_VERSION="$(config-get version)"
        
        npm_package="openclaw"
        if [ -n "$OPENCLAW_VERSION" ] && [ "$OPENCLAW_VERSION" != "latest" ]; then
            npm_package="openclaw@${OPENCLAW_VERSION}"
        fi
        
        case "$INSTALL_METHOD" in
            npm|pnpm)
                sudo -u ubuntu bash -l -c "
                    export NVM_DIR=\"/home/ubuntu/.nvm\"
                    [ -s \"\$NVM_DIR/nvm.sh\" ] && . \"\$NVM_DIR/nvm.sh\"
                    nvm use $(config-get node-version)
                    npm install -g ${npm_package}
                "
                update_openclaw_symlink
                ;;
            bun)
                bun_package="openclaw"
                if [ -n "$OPENCLAW_VERSION" ] && [ "$OPENCLAW_VERSION" != "latest" ]; then
                    bun_package="openclaw@${OPENCLAW_VERSION}"
                fi
                sudo -u ubuntu bash -l -c "bun install -g ${bun_package}"
                update_openclaw_symlink
                ;;
            source)
                sudo -u ubuntu bash -l -c "
                    export NVM_DIR=\"/home/ubuntu/.nvm\"
                    [ -s \"\$NVM_DIR/nvm.sh\" ] && . \"\$NVM_DIR/nvm.sh\"
                    nvm use $(config-get node-version)
                    cd /home/ubuntu/openclaw && git fetch && git checkout ${OPENCLAW_VERSION} && pnpm install && pnpm build
                "
                update_openclaw_symlink
                ;;
        esac
        
        INSTALLED_VERSION=$(sudo -u ubuntu bash -l -c "
            export NVM_DIR=\"/home/ubuntu/.nvm\"
            [ -s \"\$NVM_DIR/nvm.sh\" ] && . \"\$NVM_DIR/nvm.sh\"
            export BUN_INSTALL=\"/home/ubuntu/.bun\"
            [ -d \"\$BUN_INSTALL/bin\" ] && export PATH=\"\$BUN_INSTALL/bin:\$PATH\"
            timeout 5 openclaw --version 2>/dev/null
        " || echo "unknown")
        log_info "OpenClaw updated to version $INSTALLED_VERSION"
    fi
    
    generate_config
    
    OLD_PORT=$(grep "OPENCLAW_GATEWAY_PORT" /home/ubuntu/.openclaw/environment 2>/dev/null | cut -d'=' -f2 || echo "")
    NEW_PORT=$(config-get gateway-port)
    
    if [ -n "$OLD_PORT" ] && [ "$OLD_PORT" != "$NEW_PORT" ]; then
        log_info "Port changed from $OLD_PORT to $NEW_PORT"
        close-port "$OLD_PORT/tcp" || true
        open-port "$NEW_PORT/tcp"
    fi
    
    if run_systemctl_user is-active --quiet openclaw-gateway.service; then
        log_info "Restarting Gateway to apply configuration changes"
        if restart_openclaw; then
            configure_browser_settings
            
            bind="$(config-get gateway-bind)"
            if [ "$bind" = "loopback" ]; then
                ip="127.0.0.1"
            else
                ip=$(unit-get private-address)
            fi
            
            gateway_token=$(jq -r '.gateway.auth.token // empty' /home/ubuntu/.openclaw/openclaw.json 2>/dev/null)
            
            # For Node connections, always use private-address even if bind is loopback
            gateway_host=$(unit-get private-address)
            
            # Update peer relation data with new Gateway info
            relation_id=$(relation-ids openclaw-cluster 2>/dev/null | head -1)
            if [ -n "$relation_id" ]; then
                log_info "Updating peer relation $relation_id with gateway info: ${gateway_host}:${NEW_PORT}"
                relation-set -r "$relation_id" gateway-host="$gateway_host" || true
                relation-set -r "$relation_id" gateway-port="$NEW_PORT" || true
                if [ -n "$gateway_token" ]; then
                    log_info "Publishing gateway token to relation"
                    relation-set -r "$relation_id" gateway-token="$gateway_token" || true
                fi
            else
                log_warn "No peer relation found, skipping relation-set"
            fi
            
            status-set active "Gateway: http://${ip}:${NEW_PORT}"
            log_info "Gateway configuration updated and service restarted"
        else
            status-set blocked "Failed to restart Gateway after config change"
            exit 1
        fi
    else
        # Gateway not currently active - might be starting up
        # Wait briefly for service to become active (e.g., during upgrade-charm)
        log_info "Gateway not currently active - waiting for service to start"
        max_wait=10
        waited=0
        while [ $waited -lt $max_wait ]; do
            sleep 1
            waited=$((waited + 1))
            if run_systemctl_user is-active --quiet openclaw-gateway.service; then
                log_info "Gateway became active after ${waited}s"
                bind="$(config-get gateway-bind)"
                if [ "$bind" = "loopback" ]; then
                    ip="127.0.0.1"
                else
                    ip=$(unit-get private-address)
                fi
                status-set active "Gateway: http://${ip}:${NEW_PORT}"
                break
            fi
        done
        
        # If still not active after waiting, check if it's expected to be running
        if ! run_systemctl_user is-active --quiet openclaw-gateway.service; then
            # Check if service is enabled (should start eventually)
            if run_systemctl_user is-enabled --quiet openclaw-gateway.service 2>/dev/null; then
                log_info "Gateway service enabled but not yet active - showing URL anyway"
                bind="$(config-get gateway-bind)"
                if [ "$bind" = "loopback" ]; then
                    ip="127.0.0.1"
                else
                    ip=$(unit-get private-address)
                fi
                status-set active "Gateway: http://${ip}:${NEW_PORT}"
            else
                log_info "Gateway not running - configuration updated for next start"
                status-set active "Configuration updated"
            fi
        fi
    fi
else
    if ! generate_node_config; then
        status-set blocked "Waiting for Gateway connection info from leader"
        log_info "Node config cannot be updated - waiting for Gateway info"
        exit 0
    fi
    
    # Stop Gateway service if it's running (happens when unit was initially misdetected as leader)
    if run_systemctl_user is-active --quiet openclaw-gateway.service 2>/dev/null; then
        log_info "Stopping Gateway service (unit is now Node)"
        run_systemctl_user stop openclaw-gateway.service || true
        run_systemctl_user disable openclaw-gateway.service || true
    fi
    
    # Create Node service if it doesn't exist
    if [ ! -f /home/ubuntu/.config/systemd/user/openclaw-node.service ]; then
        log_info "Creating Node service"
        if ! create_node_systemd_service; then
            status-set blocked "Failed to create Node service"
            exit 1
        fi
    fi
    
    update_node_service_token
    
    # Start or restart Node service
    if run_systemctl_user is-active --quiet openclaw-node.service 2>/dev/null; then
        log_info "Restarting Node to apply configuration changes"
        if restart_openclaw_node; then
            gateway_unit=""
            gateway_host=""
            gateway_port=""
            gateway_token=""
            read -r gateway_unit gateway_host gateway_port gateway_token <<< "$(get_gateway_info)"
            
            if [ -n "$gateway_unit" ]; then
                status-set active "Node - connected to ${gateway_unit}"
            elif [ -n "$gateway_host" ] && [ -n "$gateway_port" ]; then
                status-set active "Node connected to ${gateway_host}:${gateway_port}"
            else
                status-set active "Node service restarted"
            fi
            log_info "Node configuration updated and service restarted"
        else
            status-set blocked "Failed to restart Node after config change"
            exit 1
        fi
    else
        log_info "Starting Node service"
        if start_openclaw_node; then
            gateway_unit=""
            gateway_host=""
            gateway_port=""
            gateway_token=""
            read -r gateway_unit gateway_host gateway_port gateway_token <<< "$(get_gateway_info)"
            
            if [ -n "$gateway_unit" ]; then
                status-set active "Node - connected to ${gateway_unit}"
            elif [ -n "$gateway_host" ] && [ -n "$gateway_port" ]; then
                status-set active "Node connected to ${gateway_host}:${gateway_port}"
            else
                status-set active "Node service started"
            fi
            log_info "Node service started successfully"
        else
            status-set blocked "Failed to start Node service"
            exit 1
        fi
    fi
fi
