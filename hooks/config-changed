#!/bin/bash
set -e

# OpenClaw Juju Charm - Config Changed Hook
# This hook handles configuration updates

CHARM_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
source "$CHARM_DIR/hooks/common.sh"

log_info "Configuration changed"

status-set maintenance "Updating configuration"

# Validate new configuration
if ! validate_config; then
    status-set blocked "Configuration validation failed - check logs"
    exit 1
fi

# Check if Node.js version changed (only for npm/pnpm/source installs)
INSTALL_METHOD="$(config-get install-method)"
if [ "$INSTALL_METHOD" != "bun" ]; then
    CURRENT_NODE_VERSION=$(node --version 2>/dev/null | cut -d'.' -f1 | sed 's/v//' || echo "0")
    CONFIGURED_NODE_VERSION=$(config-get node-version)
    
    if [ "$CURRENT_NODE_VERSION" != "$CONFIGURED_NODE_VERSION" ]; then
        log_info "Node.js version changed - reinstalling"
        install_nodejs
    fi
fi

# Check if auto-update is enabled and version changed
if [ "$(config-get auto-update)" = "True" ]; then
    log_info "Auto-update enabled - checking for updates"
    INSTALL_METHOD="$(config-get install-method)"
    OPENCLAW_VERSION="$(config-get version)"
    
    case "$INSTALL_METHOD" in
        npm)
            su - openclaw -c "npm update -g openclaw@${OPENCLAW_VERSION}"
            ;;
        pnpm)
            su - openclaw -c "pnpm update -g openclaw@${OPENCLAW_VERSION}"
            ;;
        source)
            su - ubuntu -c "cd /home/ubuntu/openclaw && git fetch && git checkout ${OPENCLAW_VERSION} && pnpm install && pnpm build"
            ;;
    esac
fi

# Regenerate configuration
generate_config

# Handle port changes
OLD_PORT=$(grep "OPENCLAW_GATEWAY_PORT" /home/ubuntu/.openclaw/environment 2>/dev/null | cut -d'=' -f2 || echo "")
NEW_PORT=$(config-get gateway-port)

if [ -n "$OLD_PORT" ] && [ "$OLD_PORT" != "$NEW_PORT" ]; then
    log_info "Port changed from $OLD_PORT to $NEW_PORT"
    close-port "$OLD_PORT/tcp" || true
    open-port "$NEW_PORT/tcp"
fi

# Restart service to apply changes
if systemctl is-active --quiet openclaw.service; then
    log_info "Restarting OpenClaw to apply configuration changes"
    if restart_openclaw; then
        status-set active "Gateway: http://$(unit-get private-address):$NEW_PORT"
        log_info "Configuration updated and service restarted"
    else
        status-set blocked "Failed to restart after config change"
        exit 1
    fi
else
    log_info "Service not running - configuration updated for next start"
    status-set active "Configuration updated"
fi
